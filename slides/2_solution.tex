% % % %
% % % % Solution
% % % %
\section{Solution}

\begin{frame}\frametitle{Domain knowledge: diabetic retinopathy symptoms}

\begin{itemize}
\item {\hyperlink{https://goo.gl/s5lMt8}{DR symptoms cheatsheet: https://goo.gl/s5lMt8}
\begin{center}
\par \includegraphics[interpolate=true,valign=c,width=0.4\textwidth]{pics/symptoms_pic.png}
\end{center}
Was prepared with assistance of Vera Shevchenko
}
\item \href{http://www.icoph.org/downloads/Diabetic-Retinopathy-Detail.pdf}{International Clinical Diabetic Retinopathy Disease Severity Scale, Detailed Table: \small http://www.icoph.org/downloads/Diabetic-Retinopathy-Detail.pdf}
\end{itemize}

\end{frame}

\subsection{Data preparation}


\begin{frame}\frametitle{Preprocessing}
\begin{columns}

\begin{column}{9cm}
\begin{itemize}
\item Crop black borders
\vspace{20pt}

\item Extent to square + resize
\vspace{20pt}

\item Optionally: crop internal square
\vspace{20pt}

\item Optionally: Local Contrast Normalization (LCN) \\ 
      $ \hat{I}_{x,y} = \frac{I_{x,y} - \mu_{x,y}}{\sigma_{x,y}} $
\end{itemize}
\end{column}

\begin{column}{6cm}
\begin{tabular}{ @{}c m{0.25cm} c }

	\includegraphics[valign=c,height=0.5cm]{pics/10_left.jpeg} & $\rightarrow$ &
    \includegraphics[valign=c,height=0.5cm]{pics/10_left.png}
    \vspace{10pt} \\ 
    
	\includegraphics[valign=c,height=0.5cm]{pics/10_left.png} & $\rightarrow$ &
    \includegraphics[valign=c,height=0.25cm]{pics/10_left.png}
	\vspace{10pt} \\ 	

	\adjustbox{valign=c}{\begin{tikzpicture}
	    \node[anchor=south west,inner sep=0] (image) at (0,0) {\includegraphics[valign=c,height=0.5cm]{pics/10_left.png}};
	        \begin{scope}[x={(image.south east)},y={(image.north west)}]
	            \draw[red] (0,0.5) -- (0.5,1) -- (1,0.5) -- (0.5,0) -- (0,0.5);
	        \end{scope}
	\end{tikzpicture}} & $\rightarrow$ &
	    \includegraphics[valign=c,height=0.5cm]{pics/10_left_inner.png}
    \vspace{10pt} \\

%    \includegraphics[valign=c,height=0.5cm]{pics/10_left.png} & $\rightarrow$ &
%    \includegraphics[valign=c,height=0.5cm]{pics/10_left_inner.png}
%	\vspace{10pt} \\

	\includegraphics[valign=c,height=0.5cm]{pics/10_left.png} & $\rightarrow$ &
	\includegraphics[valign=c,height=0.5cm]{pics/10_left_lcn.png}
	\\


\end{tabular}
\end{column}

\end{columns}
\end{frame}

\begin{frame}\frametitle{Augmentation}
\begin{itemize}
\item Random mirror
\item Random rotation
\item Color augmentation - not helped
\end{itemize}

\end{frame}

\subsection{Network configuration}
\begin{frame}\frametitle{}
\par Slice rotate
\par Merge
\par Output
\end{frame}

\subsection{Network configuration}

\begin{frame}\frametitle{Network configuration}
\centering
\begin{table}[]
\tiny
\centering
\begin{tabular}{@{}clcllr@{}}
\toprule
   & Layer type                & Size &             & Output Shape        & Outputs \\ \midrule
1  & InputLayer                &      &             & (64, 3, 256, 256)   & $196\,608$  \\
2  & \textbf{SliceRotateLayer} &      &             & (256, 3, 128, 128)  & $49\,152$   \\
3  & Conv2DDNNLayer            & 3x3  & LReLU       & (256, 64, 126, 126) & $1\,016\,064$ \\
4  & MaxPool2DDNNLayer         & 3x3  & stride 2x2  & (256, 64, 62, 62)   & $246\,016$  \\
5  & DropoutLayer              &      & P=0.1       & (256, 64, 62, 62)   & $246\,016$  \\
6  & Conv2DDNNLayer            & 3x3  &             & (256, 96, 60, 60)   & $345\,600$  \\
7  & MaxPool2DDNNLayer         & 3x3  & stride 2x2  & (256, 96, 29, 29)   & $80\,736$   \\
8  & DropoutLayer              &      & P=0.2       & (256, 96, 29, 29)   & $80\,736$   \\
9  & Conv2DDNNLayer            & 3x3  & LReLU       & (256, 128, 27, 27)  & $93\,312$   \\
10 & DropoutLayer              &      & P=0.3       & (256, 128, 27, 27)  & $93\,312$   \\
11 & Conv2DDNNLayer            & 3x3  & LReLU       & (256, 96, 25, 25)   & $60\,000$   \\
12 & MaxPool2DDNNLayer         & 3x3  & stride 2x2  & (256, 96, 12, 12)   & $13\,824$   \\
13 & DropoutLayer              &      & P=0.4       & (256, 96, 12, 12)   & $13\,824$   \\
14 & Conv2DDNNLayer            & 3x3  & LReLU       & (256, 128, 10, 10)  & $12\,800$   \\
15 & MaxPool2DDNNLayer         & 2x2  & stride 2x2  & (256, 128, 5, 5)    & $3\,200$    \\
16 & \textbf{RotateMergeLayer} &      &             & (64, 12800)         & $12\,800$   \\
17 & DropoutLayer              &      & P=0.5       & (64, 12800)         & $12\,800$   \\
18 & DenseLayer                & 512  &             & (64, 512)           & $512$     \\
19 & FeaturePoolLayer          &      & FeaturePool & (64, 256)           & $256$     \\
20 & DropoutLayer              &      & P=0.5       & (64, 256)           & $256$     \\
21 & DenseLayer                & 512  &             & (64, 512)           & $512$     \\
22 & FeaturePoolLayer          &      & FeaturePool & (64, 256)           & $256$     \\
23 & DropoutLayer              &      & P=0.5       & (64, 256)           & $256$     \\
24 & DenseLayer                &      &             & (64, 4)             & $4$       \\ \bottomrule
\end{tabular}
\end{table}

\end{frame}


\begin{frame}\frametitle{Special layers}

\begin{columns}
\begin{column}{5cm}
\centering
\par SliceRotateLayer

\begin{tikzpicture}[auto, node distance=0.1cm, >=latex]
	\node[anchor=south west,inner sep=0] (image) at (0,0) {\includegraphics[valign=c,height=1.0cm]{pics/10_left.png}};
	\begin{scope}[x={(image.south east)},y={(image.north west)}]
		\draw[yellow,line width=0.4mm] (0,0.51)    rectangle (0.49,1);
		\draw[blue,line width=0.4mm]   (0.51,0)    rectangle (1,0.49);
		\draw[red,line width=0.4mm]    (0,0)       rectangle (0.49,0.49);
		\draw[green,line width=0.4mm]  (0.51,0.51) rectangle (1,1);
	\end{scope}

\end{tikzpicture}

\vspace{0.25cm}

\begin{tikzpicture}
% Layers
\begin{scope}[x={(-0.7cm,0.7cm)}, y={(1.25cm,.3cm)}, z={(0cm,0.1cm)}]
\node[canvas is yx plane at z=0,transform shape] at (0,0) {
	\adjincludegraphics[height=1.0cm,trim={0 0 {.5\width} {.5\width}},clip]{pics/10_left.png}};
\node[canvas is yx plane at z=2,transform shape] at (0,0) {
	\adjincludegraphics[height=1.0cm,trim={{.5\width} {.5\width} 0 0},clip]{pics/10_left.png}};
\node[canvas is yx plane at z=4,transform shape] at (0,0) {
	\adjincludegraphics[height=1.0cm,trim={0 {.5\width} {.5\width} 0},clip]{pics/10_left.png}};
\node[canvas is yx plane at z=6,transform shape] at (0,0) {
	\adjincludegraphics[height=1.0cm,trim={0 0 {.5\width} {.5\width}},clip]{pics/10_left.png}};
\end{scope}
\end{tikzpicture}

\end{column}
\begin{column}{5cm}
\par RotateMergeLayer
\end{column}
\end{columns}

\end{frame}

\subsection{Activations}

\begin{frame}\frametitle{}
\begin{center}
\includegraphics[valign=t,scale=0.25]{pics/relus.pdf}
\end{center}
\par We used Leaky ReLUs for convolutional layer, this activation function acts like a regularizer.
\par Used Maxout\footnote{\href{http://arxiv.org/abs/1302.4389v4}{Maxout Networks. http://arxiv.org/abs/1302.4389v4}} activations for fully-connected layers.
\end{frame}

\subsection{Ordinal regression}

\begin{frame}\frametitle{}
\begin{itemize}

\item Ordinal regression\footnote{\href{https://web.missouri.edu/~zwyw6/files/rank.pdf}{A Neural Network Approach to Ordinal Regression}} is like an ordered classification.
\item Target coding: \\\vspace{0.25cm}
0 $\rightarrow$  0 0 0 0\\
2 $\rightarrow$  1 1 0 0\\
4 $\rightarrow$  1 1 1 1\\
\item Do not normalize the sigmoids in the last fully-connected layer:\\\vspace{0.5cm}
\begin{center}
\begin{Large}
$\frac{e^{-z_i}}{\sum\limits_{i=1}^Ke^{-z_i}}$ $\rightarrow$ $\frac{1}{1 + e^{-z_i}}$
\end{Large}
\end{center}
\end{itemize}
\end{frame}


\subsection{Decision making}

\begin{frame}\frametitle{}
\par Predict score for eyes independently
\par Final score = max(left, right)
\end{frame}


\input{2_2_ma_detection}